name: Conda Release Publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: Release tag to publish (for example v3.1.0)
        required: true
        type: string

jobs:
  build-and-publish:
    name: Publish (${{ matrix.os }} | mpi=${{ matrix.mpi }}, openmp=${{ matrix.openmp }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        mpi: [nompi, openmpi, mpich]
        openmp: [on, off]

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6

      - name: Resolve package version from release tag
        id: version
        shell: bash
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name || github.event.inputs.release_tag }}
        run: |
          set -euo pipefail
          if [ -z "${RELEASE_TAG:-}" ]; then
            echo "::error::Release tag is empty."
            exit 1
          fi

          version="${RELEASE_TAG#refs/tags/}"
          version="${version#v}"

          if ! [[ "${version}" =~ ^[0-9]+(\.[0-9]+){1,3}([A-Za-z0-9._-]+)?$ ]]; then
            echo "::error::Unsupported release tag '${RELEASE_TAG}'. Use tags like v3.1.0 or 3.1.0."
            exit 1
          fi

          echo "version=${version}" >> "${GITHUB_OUTPUT}"
          echo "Using package version ${version}"

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: conda-build-env
          auto-update-conda: true
          channels: conda-forge
          channel-priority: strict
          python-version: "3.12"

      - name: Install conda tooling
        shell: bash -el {0}
        run: |
          conda install -n conda-build-env -y conda-build anaconda-client

      - name: Build package variant
        shell: bash -el {0}
        env:
          CONDA_BLD_PATH: ${{ runner.temp }}/conda-bld
          HYPRE_VERSION: ${{ steps.version.outputs.version }}
        run: |
          set -euo pipefail
          echo "Building version=${HYPRE_VERSION}, mpi=${{ matrix.mpi }}, openmp=${{ matrix.openmp }}"
          variant_json=$(printf '{"mpi":"%s","openmp":"%s"}' "${{ matrix.mpi }}" "${{ matrix.openmp }}")
          conda build conda-recipe \
            --channel conda-forge \
            --override-channels \
            --variants "${variant_json}" \
            --no-anaconda-upload

      - name: Upload package to Anaconda (opflow-dev)
        shell: bash -el {0}
        env:
          CONDA_BLD_PATH: ${{ runner.temp }}/conda-bld
          HYPRE_VERSION: ${{ steps.version.outputs.version }}
          ANACONDA_API_TOKEN: ${{ secrets.ANACONDA_API_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${ANACONDA_API_TOKEN:-}" ]; then
            echo "::error::Missing secret ANACONDA_API_TOKEN."
            exit 1
          fi

          pkg_files="$(
            find "${CONDA_BLD_PATH}" -type f \
              \( -name "hypre-${HYPRE_VERSION}-*.conda" -o -name "hypre-${HYPRE_VERSION}-*.tar.bz2" \) \
              | sort
          )"

          if [ -z "${pkg_files}" ]; then
            echo "::error::No built packages found under ${CONDA_BLD_PATH}."
            exit 1
          fi

          echo "Uploading packages:"
          printf '%s\n' "${pkg_files}"

          while IFS= read -r pkg; do
            [ -n "${pkg}" ] || continue
            anaconda -t "${ANACONDA_API_TOKEN}" upload \
              --user opflow-dev \
              --label main \
              --skip-existing \
              "${pkg}"
          done <<< "${pkg_files}"
